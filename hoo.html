<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QuizBit ‚Äî Dashboard & Multi-Category Quizzes</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      /* ------------------------------------------------------
       Visual System / Custom Styles
       - Carefully designed gradients, shadows, glass cards
       - Smooth transitions, subtle micro-interactions
       ------------------------------------------------------ */

      :root {
        --bg-1: #0f172a;
        --bg-2: #071129;
        --acc-1: #7c3aed;
        --acc-2: #ec4899;
        --accent-gradient: linear-gradient(90deg, var(--acc-1), var(--acc-2));
        --glass: rgba(255, 255, 255, 0.04);
        --glass-2: rgba(255, 255, 255, 0.03);
        --muted: rgba(230, 238, 248, 0.75);
      }

      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        margin: 0;
        background: radial-gradient(
            800px 400px at 10% 10%,
            rgba(124, 58, 237, 0.09),
            transparent 8%
          ),
          radial-gradient(
            700px 350px at 95% 80%,
            rgba(236, 72, 153, 0.06),
            transparent 8%
          ),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
        color: #e6eef8;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Layout container */
      .app-shell {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 32px;
        align-items: start;
        padding: 48px;
        box-sizing: border-box;
      }

      /* Mobile fallback: single column */
      @media (max-width: 960px) {
        .app-shell {
          grid-template-columns: 1fr;
          padding: 20px;
        }
      }

      /* Sidebar card (dark glass) */
      .sidebar {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        padding: 22px;
        box-shadow: 0 10px 40px rgba(2, 6, 23, 0.55);
      }

      .content {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 18px;
        padding: 26px;
        box-shadow: 0 12px 50px rgba(2, 6, 23, 0.45);
        min-height: 70vh;
      }

      h1.logo {
        font-weight: 800;
        font-size: 22px;
        letter-spacing: -0.02em;
        margin: 0;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .small-muted {
        color: var(--muted);
        font-size: 13px;
      }

      /* Profile circle */
      .avatar {
        width: 72px;
        height: 72px;
        border-radius: 14px;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      /* Hall of badges */
      .badge-pill {
        background: linear-gradient(90deg, #ffffff10, #ffffff05);
        border: 1px solid rgba(255, 255, 255, 0.04);
        padding: 8px 12px;
        border-radius: 999px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      /* Quiz category tiles */
      .category-tile {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid rgba(255, 255, 255, 0.03);
        padding: 16px;
        border-radius: 12px;
        transition: transform 0.18s cubic-bezier(0.2, 0.9, 0.3, 1),
          box-shadow 0.18s;
      }
      .category-tile:hover {
        transform: translateY(-6px) scale(1.01);
        box-shadow: 0 12px 40px rgba(3, 7, 18, 0.6);
        cursor: pointer;
      }

      /* Option card */
      .option {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        padding: 14px;
        border-radius: 12px;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          background-color 0.12s;
      }
      .option:hover {
        transform: translateX(8px);
        box-shadow: 0 10px 26px rgba(2, 6, 23, 0.45);
      }
      .option.correct {
        background: linear-gradient(90deg, #10b98144, #05966922);
        border-color: #10b98166;
        color: #ecfff6;
      }
      .option.wrong {
        background: linear-gradient(90deg, #ef444444, #dc262644);
        border-color: #ef4444bb;
        color: #fff0f0;
      }

      /* Progress bar custom */
      .progress-track {
        height: 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 999px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #7c3aed, #ec4899);
        transition: width 0.5s cubic-bezier(0.2, 0.9, 0.3, 1);
      }

      /* Fancy button */
      .btn-primary {
        background: linear-gradient(90deg, #7c3aed, #ec4899);
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: 700;
        box-shadow: 0 8px 30px rgba(124, 58, 237, 0.14);
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 8px 12px;
        border-radius: 10px;
      }

      /* subtle utilities */
      .muted {
        color: rgba(230, 238, 248, 0.65);
      }
      .tiny {
        font-size: 12px;
        color: rgba(230, 238, 248, 0.6);
      }

      /* animations */
      .fade-in {
        animation: fadeIn 0.45s ease forwards;
        opacity: 0;
        transform: translateY(6px);
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
          transform: none;
        }
      }

      /* responsive adjustments */
      @media (max-width: 760px) {
        .avatar {
          width: 60px;
          height: 60px;
        }
        .app-shell {
          padding: 18px;
          gap: 18px;
        }
      }
    </style>
  </head>
  <body>
    <!-- App shell: sidebar (left) + main content (right) -->
    <div class="app-shell">
      <!-- SIDEBAR / DASHBOARD -->
      <aside class="sidebar">
        <div class="flex items-center gap-3 mb-4">
          <div class="avatar" id="avatarWrap" title="Your avatar">
            <!-- Avatar image injected -->
            <img
              id="avatarImg"
              src="https://api.dicebear.com/7.x/adventurer/svg?seed=Coder"
              alt="avatar"
              style="width: 100%; height: 100%; object-fit: cover"
            />
          </div>
          <div>
            <h1 class="logo" id="appLogo">QuizBit</h1>
            <div class="tiny muted">Level up your coding</div>
          </div>
        </div>

        <!-- Profile -->
        <div class="mt-4 mb-6">
          <label class="tiny muted block mb-2">Display name</label>
          <input
            id="displayName"
            class="w-full rounded-md p-2 bg-transparent border border-white/6 text-white placeholder:text-white/60"
            placeholder="Your name"
          />
          <div class="mt-3 flex gap-2">
            <button id="saveProfile" class="btn-primary flex-1">
              Save Profile
            </button>
            <button id="resetProfile" class="btn-ghost">Reset</button>
          </div>
        </div>

        <!-- Badges summary -->
        <div class="mt-6 mb-6">
          <div class="flex items-center justify-between mb-3">
            <div class="tiny muted">Badges</div>
            <div class="tiny muted" id="badgesCount">0</div>
          </div>

          <div id="sidebarBadges" class="flex gap-2 flex-wrap">
            <!-- badges go here -->
          </div>
        </div>

        <!-- Quick stats -->
        <div class="mt-6 mb-6">
          <div class="tiny muted mb-2">Progress</div>
          <div class="progress-track">
            <div
              id="sidebarProgress"
              class="progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <div class="tiny muted mt-2">
            Quizzes taken: <span id="takenCount">0</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6">
          <button id="btnTakeQuiz" class="btn-primary w-full mb-2">
            Take a Quiz
          </button>
          <button id="btnExport" class="btn-ghost w-full mb-2">
            Export Data
          </button>
          <button id="btnClear" class="btn-ghost w-full">Clear Data</button>
        </div>

        <div class="tiny muted mt-6 text-center">Made with ‚ù§Ô∏è ‚Äî QuizBit</div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="content">
        <!-- Top controls -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <div class="small-muted">Welcome back,</div>
            <div class="text-2xl font-bold" id="welcomeName">Guest</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="tiny muted text-right">
              <div id="todayDate"></div>
              <div id="timeNow"></div>
            </div>
          </div>
        </div>

        <!-- Screens container -->
        <section id="screens">
          <!-- SCREEN: Dashboard Overview -->
          <div id="screen-dashboard" class="fade-in">
            <div class="grid grid-cols-2 gap-6 mb-6">
              <div class="category-tile p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="tiny muted">Total Score (last attempt)</div>
                    <div id="lastScore" class="text-2xl font-semibold">‚Äî</div>
                  </div>
                  <div class="badge-pill">
                    <div id="lastBadgeEmoji" class="text-xl">‚Äî</div>
                    <div class="tiny muted">Badge</div>
                  </div>
                </div>
                <p class="tiny muted mt-4">
                  Your most recent attempt summary, badge and quick action.
                </p>
              </div>

              <div class="category-tile p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="tiny muted">Total Attempts</div>
                    <div id="totalAttempts" class="text-2xl font-semibold">
                      0
                    </div>
                  </div>
                  <div class="badge-pill">
                    <div class="tiny muted">XP</div>
                    <div id="xpPoints" class="text-lg font-semibold ml-2">
                      0
                    </div>
                  </div>
                </div>
                <p class="tiny muted mt-4">
                  Earn XP and level up by completing quizzes and improving
                  scores.
                </p>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-6">
              <div class="category-tile p-5 col-span-2">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <div class="tiny muted">Choose a Category</div>
                    <div class="text-xl font-bold">Pick one to start</div>
                  </div>
                  <div class="tiny muted">
                    Difficulty: <span id="selectedDifficulty">Normal</span>
                  </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mt-4">
                  <!-- category cards -->
                  <div
                    class="category-tile p-4 text-center cursor-pointer"
                    data-cat="html"
                  >
                    <div class="text-3xl mb-2">üåê</div>
                    <div class="font-semibold">HTML</div>
                    <div class="tiny muted mt-1">Structure & Tags</div>
                  </div>

                  <div
                    class="category-tile p-4 text-center cursor-pointer"
                    data-cat="javascript"
                  >
                    <div class="text-3xl mb-2">üü®</div>
                    <div class="font-semibold">JavaScript</div>
                    <div class="tiny muted mt-1">DOM & Logic</div>
                  </div>

                  <div
                    class="category-tile p-4 text-center cursor-pointer"
                    data-cat="python"
                  >
                    <div class="text-3xl mb-2">üêç</div>
                    <div class="font-semibold">Python</div>
                    <div class="tiny muted mt-1">Syntax & Basics</div>
                  </div>

                  <div
                    class="category-tile p-4 text-center cursor-pointer"
                    data-cat="java"
                  >
                    <div class="text-3xl mb-2">‚òï</div>
                    <div class="font-semibold">Java</div>
                    <div class="tiny muted mt-1">OOP & Types</div>
                  </div>

                  <div
                    class="category-tile p-4 text-center cursor-pointer"
                    data-cat="c"
                  >
                    <div class="text-3xl mb-2">üîß</div>
                    <div class="font-semibold">C</div>
                    <div class="tiny muted mt-1">Low-level Basics</div>
                  </div>

                  <div
                    class="category-tile p-4 text-center cursor-pointer"
                    id="customCategory"
                  >
                    <div class="text-3xl mb-2">‚ú≥Ô∏è</div>
                    <div class="font-semibold">Custom</div>
                    <div class="tiny muted mt-1">Add your own</div>
                  </div>
                </div>
              </div>

              <div class="category-tile p-5">
                <div class="tiny muted">Leaderboard (local)</div>
                <div class="text-lg font-bold mb-3">Top Scores</div>
                <div id="leaderboard" class="space-y-2 tiny muted">
                  <!-- dynamic -->
                </div>
              </div>
            </div>
          </div>

          <!-- SCREEN: Quiz Runner -->
          <div id="screen-quiz" class="hidden">
            <div class="flex items-center justify-between mb-6">
              <div>
                <div class="tiny muted" id="quizCategoryLabel">Category</div>
                <div class="text-2xl font-bold" id="quizTitle">Quiz</div>
              </div>
              <div class="text-right">
                <div class="tiny muted">Time left</div>
                <div id="timeLeft" class="font-mono font-semibold text-lg">
                  05:00
                </div>
              </div>
            </div>

            <div class="category-tile p-6 mb-6">
              <div id="questionText" class="text-xl font-semibold mb-4">
                Question appears here
              </div>

              <div id="optionsList" class="grid gap-3">
                <!-- options injected here -->
              </div>

              <div class="flex items-center justify-between mt-6">
                <div class="tiny muted">Progress</div>
                <div class="tiny muted" id="progressText">0/0</div>
              </div>

              <div class="progress-track mt-3">
                <div
                  id="quizProgressFill"
                  class="progress-fill"
                  style="width: 0%"
                ></div>
              </div>

              <div class="mt-6 flex items-center justify-between">
                <div class="flex gap-2">
                  <button id="prevQ" class="btn-ghost">Prev</button>
                  <button id="nextQ" class="btn-primary">Next</button>
                </div>
                <div>
                  <button id="quitQuiz" class="btn-ghost">Quit</button>
                </div>
              </div>
            </div>
          </div>

          <!-- SCREEN: Results -->
          <div id="screen-results" class="hidden">
            <div class="category-tile p-6 text-center">
              <div id="resultBadge" class="text-6xl mb-4">üèÖ</div>
              <div class="text-3xl font-bold mb-2" id="resultTitle">Result</div>
              <div class="tiny muted mb-4" id="resultSummary">
                Score and summary
              </div>

              <div class="flex gap-3 justify-center">
                <button id="saveResult" class="btn-primary">
                  Save to Profile
                </button>
                <button id="retryQuiz" class="btn-ghost">Retry</button>
                <button id="backToDash" class="btn-ghost">
                  Back to Dashboard
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- SCRIPTS -->
    <script>
      /* ======================================================
       QuizBit ‚Äî Dashboard + Multi-category quiz
       Single-file app
       - persistent via localStorage
       - confetti + audio feedback
       - keyboard shortcuts
       ====================================================== */

      // ------------------------------
      // Basic Data: question banks by category
      // ------------------------------
      const BANKS = {
        html: [
          {
            q: "What does HTML stand for?",
            opts: [
              "Hyper Text Markup Language",
              "Hot Mail",
              "Home Tool Markup Language",
              "HighText Machine Language",
            ],
            a: 0,
          },
          {
            q: "Which tag is used to create a hyperlink?",
            opts: ["<a>", "<p>", "<link>", "<href>"],
            a: 0,
          },
          {
            q: "Which tag inserts an image?",
            opts: ["<img>", "<image>", "<src>", "<picture>"],
            a: 0,
          },
          {
            q: "Which tag is used for a paragraph?",
            opts: ["<p>", "<para>", "<text>", "<paragraph>"],
            a: 0,
          },
        ],
        javascript: [
          {
            q: "Which company created JavaScript?",
            opts: ["Netscape", "Microsoft", "Sun Microsystems", "Oracle"],
            a: 0,
          },
          {
            q: "Which of these is NOT a JavaScript data type?",
            opts: ["String", "Number", "Boolean", "Character"],
            a: 3,
          },
          {
            q: "Which method adds an item to the end of an array?",
            opts: ["push()", "pop()", "shift()", "unshift()"],
            a: 0,
          },
          {
            q: "What does DOM stand for?",
            opts: [
              "Document Object Model",
              "Data Object Model",
              "Digital Oriented Model",
              "Document Ordered Map",
            ],
            a: 0,
          },
        ],
        python: [
          {
            q: "Who created Python?",
            opts: [
              "Guido van Rossum",
              "James Gosling",
              "Bjarne Stroustrup",
              "Brendan Eich",
            ],
            a: 0,
          },
          {
            q: "Which keyword defines a function in Python?",
            opts: ["def", "function", "func", "fn"],
            a: 0,
          },
          {
            q: "Which symbol starts a single-line comment in Python?",
            opts: ["#", "//", "/*", "<!--"],
            a: 0,
          },
          {
            q: "Which of these is a Python data structure?",
            opts: ["List", "ArrayList", "Vector", "Buffer"],
            a: 0,
          },
        ],
        java: [
          {
            q: "Which keyword declares a class in Java?",
            opts: ["class", "def", "struct", "object"],
            a: 0,
          },
          {
            q: "Which file extension is used by Java source files?",
            opts: [".java", ".js", ".py", ".class"],
            a: 0,
          },
          {
            q: "Which company originally developed Java?",
            opts: ["Sun Microsystems", "Microsoft", "Apple", "IBM"],
            a: 0,
          },
          {
            q: "Which of these is a primitive type in Java?",
            opts: ["int", "String", "ArrayList", "Object"],
            a: 0,
          },
        ],
        c: [
          {
            q: "Who created C?",
            opts: [
              "Dennis Ritchie",
              "Bjarne Stroustrup",
              "Ken Thompson",
              "Linus Torvalds",
            ],
            a: 0,
          },
          {
            q: "Which symbol terminates a statement in C?",
            opts: [";", ":", ".", ","],
            a: 0,
          },
          {
            q: "Which header provides printf function?",
            opts: ["stdio.h", "stdlib.h", "string.h", "math.h"],
            a: 0,
          },
          {
            q: "What is the return type of main in C (standard)?",
            opts: ["int", "void", "main", "program"],
            a: 0,
          },
        ],
      };

      // ------------------------------
      // Local storage keys and helpers
      // ------------------------------
      const LS = {
        PROFILE: "quizbit_profile_v1",
        HISTORY: "quizbit_history_v1",
        XP: "quizbit_xp_v1",
      };

      function loadProfile() {
        try {
          const raw = localStorage.getItem(LS.PROFILE);
          return raw ? JSON.parse(raw) : { name: "", avatarSeed: "Coder" };
        } catch (e) {
          return { name: "", avatarSeed: "Coder" };
        }
      }

      function saveProfile(profile) {
        localStorage.setItem(LS.PROFILE, JSON.stringify(profile));
      }

      function loadHistory() {
        try {
          const raw = localStorage.getItem(LS.HISTORY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          return [];
        }
      }

      function saveHistory(hist) {
        localStorage.setItem(LS.HISTORY, JSON.stringify(hist));
      }

      function loadXP() {
        return Number(localStorage.getItem(LS.XP) || 0);
      }
      function saveXP(v) {
        localStorage.setItem(LS.XP, String(v));
      }

      // ------------------------------
      // UI references
      // ------------------------------
      const displayNameEl = document.getElementById("displayName");
      const avatarImg = document.getElementById("avatarImg");
      const saveProfileBtn = document.getElementById("saveProfile");
      const resetProfileBtn = document.getElementById("resetProfile");
      const btnTakeQuiz = document.getElementById("btnTakeQuiz");
      const btnExport = document.getElementById("btnExport");
      const btnClear = document.getElementById("btnClear");
      const sidebarBadges = document.getElementById("sidebarBadges");
      const badgesCount = document.getElementById("badgesCount");
      const sidebarProgress = document.getElementById("sidebarProgress");
      const takenCount = document.getElementById("takenCount");

      const screenDashboard = document.getElementById("screen-dashboard");
      const screenQuiz = document.getElementById("screen-quiz");
      const screenResults = document.getElementById("screen-results");

      const todayDate = document.getElementById("todayDate");
      const timeNow = document.getElementById("timeNow");
      const welcomeName = document.getElementById("welcomeName");
      const lastScoreEl = document.getElementById("lastScore");
      const lastBadgeEmoji = document.getElementById("lastBadgeEmoji");
      const totalAttemptsEl = document.getElementById("totalAttempts");
      const xpPointsEl = document.getElementById("xpPoints");

      // quiz elements
      const quizCategoryLabel = document.getElementById("quizCategoryLabel");
      const quizTitle = document.getElementById("quizTitle");
      const timeLeftEl = document.getElementById("timeLeft");
      const questionText = document.getElementById("questionText");
      const optionsList = document.getElementById("optionsList");
      const quizProgressFill = document.getElementById("quizProgressFill");
      const progressText = document.getElementById("progressText");
      const prevQBtn = document.getElementById("prevQ");
      const nextQBtn = document.getElementById("nextQ");
      const quitQuizBtn = document.getElementById("quitQuiz");

      // result elements
      const resultBadge = document.getElementById("resultBadge");
      const resultTitle = document.getElementById("resultTitle");
      const resultSummary = document.getElementById("resultSummary");
      const saveResultBtn = document.getElementById("saveResult");
      const retryQuizBtn = document.getElementById("retryQuiz");
      const backToDashBtn = document.getElementById("backToDash");

      // leader board
      const leaderboardEl = document.getElementById("leaderboard");

      // state
      let profile = loadProfile();
      let history = loadHistory();
      let xp = loadXP();

      let state = {
        activeCategory: null,
        bank: [],
        currentIndex: 0,
        answers: [],
        score: 0,
        startedAt: null,
        timeLimit: 300,
        timerId: null,
        remaining: 300,
      };

      // ------------------------------
      // Utilities: time and sound
      // ------------------------------
      function formatMMSS(sec) {
        const m = Math.floor(sec / 60)
          .toString()
          .padStart(2, "0");
        const s = (sec % 60).toString().padStart(2, "0");
        return `${m}:${s}`;
      }

      // small beep/click sounds using WebAudio
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = AudioCtx ? new AudioCtx() : null;
      function tone(freq = 440, time = 0.06) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = 0;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        g.gain.linearRampToValueAtTime(0.08, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(
          0.0001,
          audioCtx.currentTime + time
        );
        o.stop(audioCtx.currentTime + time + 0.02);
      }

      // ------------------------------
      // PROFILE & UI INIT
      // ------------------------------
      function initProfileUI() {
        displayNameEl.value = profile.name || "";
        avatarImg.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(
          profile.avatarSeed || "Coder"
        )}`;
        welcomeName.textContent = profile.name || "Guest";
      }

      saveProfileBtn.addEventListener("click", () => {
        profile.name = displayNameEl.value.trim() || "Guest";
        // re-generate avatar seed from name for some variety
        profile.avatarSeed = profile.name
          ? profile.name + Date.now().toString().slice(-3)
          : "Coder";
        saveProfile(profile);
        initProfileUI();
        tone(880, 0.06);
        alert("Profile saved locally.");
      });

      resetProfileBtn.addEventListener("click", () => {
        if (confirm("Reset profile (local only)?")) {
          profile = { name: "", avatarSeed: "Coder" };
          saveProfile(profile);
          initProfileUI();
        }
      });

      // ------------------------------
      // DASHBOARD: render history and badges
      // ------------------------------
      function computeXPFromHistory(hist) {
        // simple scoring: each attempt percent / 10 => xp
        let total = 0;
        for (const a of hist) {
          total += a.percent || 0;
        }
        return Math.round(total / (hist.length || 1));
      }

      function updateDashboard() {
        // badges: gather unique badges and show top 6
        const badges = [...new Set(history.map((h) => h.badgeEmoji))].slice(
          0,
          6
        );
        sidebarBadges.innerHTML = "";
        for (const b of badges) {
          const s = document.createElement("div");
          s.className = "badge-pill";
          s.innerHTML = `<div style="font-size:18px">${b}</div><div class="tiny muted ml-2">earned</div>`;
          sidebarBadges.appendChild(s);
        }
        badgesCount.textContent = badges.length;

        // attempts and XP
        takenCount.textContent = history.length;
        xp = computeXPFromHistory(history);
        xpPointsEl.textContent = xp;
        totalAttemptsEl.textContent = history.length;

        // sidebar progress is percent of best attempt / 100
        const best = history.length
          ? Math.max(...history.map((h) => h.percent || 0))
          : 0;
        sidebarProgress.style.width = Math.min(best, 100) + "%";

        // recent attempt summary
        if (history.length) {
          const last = history[0];
          lastScoreEl.textContent = `${last.score}/${last.total} (${last.percent}%)`;
          lastBadgeEmoji.textContent = last.badgeEmoji;
        } else {
          lastScoreEl.textContent = "‚Äî";
          lastBadgeEmoji.textContent = "‚Äî";
        }

        // leaderboard local: top 5 by percent
        const top = [...history]
          .sort((a, b) => b.percent - a.percent)
          .slice(0, 5);
        leaderboardEl.innerHTML = top
          .map(
            (t, i) =>
              `<div class="flex items-center justify-between"><div class="tiny muted">${
                i + 1
              }. ${t.cat}</div><div class="font-semibold">${
                t.percent
              }%</div></div>`
          )
          .join("");
      }

      // ------------------------------
      // CATEGORY selection
      // ------------------------------
      document.querySelectorAll("[data-cat]").forEach((el) => {
        el.addEventListener("click", (e) => {
          const cat = el.getAttribute("data-cat");
          if (cat === "custom") {
            // custom not implemented, prompt user
            const name = prompt("Enter a custom category name (not saved):");
            if (name) {
              alert(
                "Custom category feature is not implemented in this demo. Choose an existing category."
              );
            }
            return;
          }
          startCategory(cat);
        });
      });

      // main "Take a Quiz" button
      btnTakeQuiz.addEventListener("click", () => {
        // navigate to dashboard categories area (the category tiles are on dashboard)
        // We'll scroll to that region (on larger screens)
        document
          .getElementById("screen-dashboard")
          .scrollIntoView({ behavior: "smooth" });
        tone(660, 0.06);
      });

      // ------------------------------
      // START a category: prepare state
      // ------------------------------
      function startCategory(cat) {
        state.activeCategory = cat;
        state.bank = (BANKS[cat] || []).map((q) => ({ ...q })); // shallow copy
        state.currentIndex = 0;
        state.answers = new Array(state.bank.length).fill(null);
        state.score = 0;
        state.startedAt = Date.now();
        state.timeLimit = 300; // 5 minutes by default
        state.remaining = state.timeLimit;

        // UI
        quizCategoryLabel.textContent = cat.toUpperCase();
        quizTitle.textContent = `${
          cat.charAt(0).toUpperCase() + cat.slice(1)
        } Quiz`;
        showScreen("quiz");

        renderQuestion();
        startTimer();
        tone(880, 0.06);
      }

      // ------------------------------
      // Timer logic
      // ------------------------------
      function startTimer() {
        if (state.timerId) clearInterval(state.timerId);
        timeLeftEl.textContent = formatMMSS(state.remaining);
        state.timerId = setInterval(() => {
          state.remaining--;
          if (state.remaining < 0) {
            clearInterval(state.timerId);
            finishQuiz();
            return;
          }
          timeLeftEl.textContent = formatMMSS(state.remaining);
        }, 1000);
      }

      function stopTimer() {
        if (state.timerId) {
          clearInterval(state.timerId);
          state.timerId = null;
        }
      }

      // ------------------------------
      // Render a question and options
      // ------------------------------
      function renderQuestion() {
        const idx = state.currentIndex;
        const item = state.bank[idx];
        if (!item) return;
        questionText.textContent = item.q;
        optionsList.innerHTML = "";

        item.opts.forEach((opt, i) => {
          const btn = document.createElement("button");
          btn.className = "option flex items-center justify-between";
          btn.innerHTML = `<div>${escapeHtml(
            opt
          )}</div><div class="tiny muted">${i + 1}</div>`;
          btn.onclick = () => chooseOption(i, btn);
          // keyboard accessible
          btn.tabIndex = 0;
          optionsList.appendChild(btn);
        });

        // progress
        progressText.textContent = `${idx + 1}/${state.bank.length}`;
        const pct = Math.round((idx / state.bank.length) * 100);
        quizProgressFill.style.width = pct + "%";

        // prev/next buttons state
        prevQBtn.disabled = idx === 0;
        nextQBtn.disabled = state.answers[idx] === null;

        // focus first option
        const first = optionsList.querySelector("button");
        if (first) first.focus();
      }

      function chooseOption(choiceIndex, element) {
        // do not allow selection again for this question
        // mark the answer in state, reveal correct/wrong
        const idx = state.currentIndex;
        state.answers[idx] = choiceIndex;
        const correct = state.bank[idx].a;

        // style each option
        Array.from(optionsList.children).forEach((el, i) => {
          el.style.pointerEvents = "none";
          el.classList.remove("correct", "wrong");
          if (i === correct) el.classList.add("correct");
          if (i === choiceIndex && choiceIndex !== correct)
            el.classList.add("wrong");
        });

        // update score
        state.score = state.answers.reduce(
          (acc, v, i) => acc + (v !== null && v === state.bank[i].a ? 1 : 0),
          0
        );

        // enable next
        nextQBtn.disabled = false;

        // brief audio feedback
        if (choiceIndex === correct) tone(880, 0.06);
        else tone(220, 0.08);
      }

      // next / prev handlers
      nextQBtn.addEventListener("click", () => {
        if (state.currentIndex < state.bank.length - 1) {
          state.currentIndex++;
          renderQuestion();
        } else {
          finishQuiz();
        }
      });

      prevQBtn.addEventListener("click", () => {
        if (state.currentIndex > 0) {
          state.currentIndex--;
          renderQuestion();
        }
      });

      quitQuizBtn.addEventListener("click", () => {
        if (confirm("Quit quiz? Your current progress will be lost.")) {
          stopTimer();
          showScreen("dashboard");
        }
      });

      // ------------------------------
      // Finish quiz and compute result
      // ------------------------------
      function finishQuiz() {
        stopTimer();
        // compute final score & percent
        const total = state.bank.length;
        const score = state.answers.reduce(
          (acc, v, i) => acc + (v !== null && v === state.bank[i].a ? 1 : 0),
          0
        );
        const percent = Math.round((score / total) * 100);

        // choose badge tier
        let badgeEmoji = "ü•â";
        let badgeName = "Novice";
        if (percent >= 86) {
          badgeEmoji = "ü•á";
          badgeName = "Expert";
        } else if (percent >= 70) {
          badgeEmoji = "üèÖ";
          badgeName = "Proficient";
        } else if (percent >= 50) {
          badgeEmoji = "ü•à";
          badgeName = "Adept";
        }

        // show result UI
        resultBadge.textContent = badgeEmoji;
        resultTitle.textContent = `${badgeName} Coder`;
        resultSummary.textContent = `You scored ${score}/${total} (${percent}%) ‚Äî Category: ${state.activeCategory.toUpperCase()}`;
        state.score = score;

        // show screen
        showScreen("results");

        // keep attempt info for saving when user clicks Save
        state.lastAttempt = {
          cat: state.activeCategory,
          score,
          total,
          percent,
          badgeEmoji,
          timestamp: new Date().toISOString(),
        };

        // confetti & flourish
        confetti({
          particleCount: 120,
          spread: 80,
          origin: { y: 0.6 },
          colors: ["#7c3aed", "#ec4899", "#f59e0b", "#06b6d4", "#10b981"],
        });
        tone(880, 0.05);
        setTimeout(() => tone(1320, 0.05), 90);
      }

      // saving result to history and updating dashboard
      saveResultBtn.addEventListener("click", () => {
        if (!state.lastAttempt) return;
        history.unshift({
          cat: state.lastAttempt.cat,
          score: state.lastAttempt.score,
          total: state.lastAttempt.total,
          percent: state.lastAttempt.percent,
          badgeEmoji: state.lastAttempt.badgeEmoji,
          date: state.lastAttempt.timestamp,
        });
        // keep history to last 200 attempts
        history = history.slice(0, 200);
        saveHistory(history);
        xp = computeXPFromHistory(history);
        saveXP(xp);
        updateDashboard();
        alert("Saved to your local profile.");
        showScreen("dashboard");
      });

      retryQuizBtn.addEventListener("click", () => {
        // reset and start same category again
        startCategory(state.activeCategory);
      });

      backToDashBtn.addEventListener("click", () => {
        showScreen("dashboard");
      });

      // ------------------------------
      // Screen router
      // ------------------------------
      function showScreen(name) {
        // hide all screens
        screenDashboard.style.display = "none";
        screenQuiz.style.display = "none";
        screenResults.style.display = "none";

        if (name === "dashboard") screenDashboard.style.display = "";
        else if (name === "quiz") screenQuiz.style.display = "";
        else if (name === "results") screenResults.style.display = "";

        // update time
        tickClock();
      }

      // ------------------------------
      // Helpers: escape HTML safely
      // ------------------------------
      function escapeHtml(unsafe) {
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ------------------------------
      // Export and clear
      // ------------------------------
      btnExport.addEventListener("click", () => {
        const payload = {
          profile,
          history,
          xp,
          exportedAt: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "quizbit_export.json";
        a.click();
        URL.revokeObjectURL(url);
        tone(660, 0.06);
      });

      btnClear.addEventListener("click", () => {
        if (
          !confirm(
            "Clear all saved data (profile, history, XP)? This cannot be undone."
          )
        )
          return;
        localStorage.removeItem(LS.PROFILE);
        localStorage.removeItem(LS.HISTORY);
        localStorage.removeItem(LS.XP);
        profile = { name: "", avatarSeed: "Coder" };
        history = [];
        xp = 0;
        saveProfile(profile);
        saveHistory(history);
        saveXP(xp);
        initProfileUI();
        updateDashboard();
        showScreen("dashboard");
      });

      // ------------------------------
      // Leaderboard (local) and quick UI
      // ------------------------------
      function populateLeaderboard() {
        // show top 5 by percent
        const top = [...history]
          .sort((a, b) => b.percent - a.percent)
          .slice(0, 5);
        leaderboardEl.innerHTML = top
          .map(
            (t, i) =>
              `<div class="flex items-center justify-between"><div class="tiny muted">${
                i + 1
              }. ${t.cat}</div><div class="font-semibold">${
                t.percent
              }%</div></div>`
          )
          .join("");
      }

      // ------------------------------
      // Clock (top right)
      // ------------------------------
      function tickClock() {
        const now = new Date();
        todayDate.textContent = now.toLocaleDateString();
        timeNow.textContent = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }
      setInterval(tickClock, 30 * 1000);
      tickClock();

      // ------------------------------
      // Keyboard shortcuts
      // ------------------------------
      window.addEventListener("keydown", (e) => {
        // If quiz screen active, allow 1-4 keys for answers, n for next, p for prev, q to quit
        if (screenQuiz.style.display !== "none") {
          if (e.key >= "1" && e.key <= "4") {
            const idx = Number(e.key) - 1;
            const el = optionsList.children[idx];
            if (el && el.style.pointerEvents !== "none") el.click();
          } else if (e.key === "n") {
            if (!nextQBtn.disabled) nextQBtn.click();
          } else if (e.key === "p") {
            if (!prevQBtn.disabled) prevQBtn.click();
          } else if (e.key === "q") {
            quitQuizBtn.click();
          }
        }
      });

      // ------------------------------
      // Init app: load profile, history, render dashboard
      // ------------------------------
      function initApp() {
        profile = loadProfile();
        history = loadHistory();
        xp = loadXP();
        initProfileUI();
        updateDashboard();
        populateLeaderboard();
        showScreen("dashboard");
      }

      // small helper to start category by name (used by retry)
      function startCategory(cat) {
        startCategoryInner(cat);
      }
      // avoid overwriting function prototype above; create inner real function
      function startCategoryInner(cat) {
        // same as previously defined startCategory, but ensure no naming collisions
        state.activeCategory = cat;
        state.bank = (BANKS[cat] || []).map((q) => ({ ...q }));
        state.currentIndex = 0;
        state.answers = new Array(state.bank.length).fill(null);
        state.score = 0;
        state.startedAt = Date.now();
        state.timeLimit = 300;
        state.remaining = state.timeLimit;

        quizCategoryLabel.textContent = cat.toUpperCase();
        quizTitle.textContent = `${
          cat.charAt(0).toUpperCase() + cat.slice(1)
        } Quiz`;
        showScreen("quiz");
        renderQuestion();
        startTimer();
        tone(880, 0.06);
      }

      // Because earlier we defined startCategory above, reassign it to inner (fix scoping)
      startCategory = startCategoryInner;

      // ------------------------------
      // initial run
      // ------------------------------
      initApp();

      // support for clicking category tiles previously bound earlier might conflict;
      // ensure category tiles binding is consistent:
      document
        .querySelectorAll(".category-tile.cursor-pointer")
        .forEach((tile) => {
          tile.onclick = () => {
            const cat = tile.getAttribute("data-cat");
            if (cat) startCategory(cat);
          };
        });

      // ensure custom category tile not broken:
      document.getElementById("customCategory").onclick = () => {
        const name = prompt("Custom category name (demo only):");
        if (name)
          alert(
            "Custom categories are not persistent in this demo. Choose a built-in category."
          );
      };

      // small helper to render question used above (closing over state)
      function renderQuestion() {
        const idx = state.currentIndex;
        const item = state.bank[idx];
        if (!item) return;
        questionText.textContent = item.q;
        optionsList.innerHTML = "";
        item.opts.forEach((opt, i) => {
          const btn = document.createElement("button");
          btn.className = "option flex items-center justify-between";
          btn.innerHTML = `<div>${escapeHtml(
            opt
          )}</div><div class="tiny muted">${i + 1}</div>`;
          btn.onclick = () => chooseOption(i, btn);
          optionsList.appendChild(btn);
        });
        progressText.textContent = `${idx + 1}/${state.bank.length}`;
        const pct = Math.round((idx / state.bank.length) * 100);
        quizProgressFill.style.width = pct + "%";
        prevQBtn.disabled = idx === 0;
        nextQBtn.disabled = state.answers[idx] === null;
      }

      function chooseOption(choiceIndex, element) {
        const idx = state.currentIndex;
        state.answers[idx] = choiceIndex;
        const correct = state.bank[idx].a;
        Array.from(optionsList.children).forEach((el, i) => {
          el.style.pointerEvents = "none";
          el.classList.remove("correct", "wrong");
          if (i === correct) el.classList.add("correct");
          if (i === choiceIndex && choiceIndex !== correct)
            el.classList.add("wrong");
        });
        state.score = state.answers.reduce(
          (acc, v, i) => acc + (v !== null && v === state.bank[i].a ? 1 : 0),
          0
        );
        nextQBtn.disabled = false;
        if (choiceIndex === correct) tone(880, 0.06);
        else tone(220, 0.08);
      }

      // rebind next/prev handlers (redeclared earlier)
      nextQBtn.onclick = () => {
        if (state.currentIndex < state.bank.length - 1) {
          state.currentIndex++;
          renderQuestion();
        } else {
          finishQuiz();
        }
      };
      prevQBtn.onclick = () => {
        if (state.currentIndex > 0) {
          state.currentIndex--;
          renderQuestion();
        }
      };
    </script>
  </body>
</html>
